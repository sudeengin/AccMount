<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>BorÃ§ Transferi Debug</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        .info { background: #264f78; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #0e6027; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { background: #5a1d1d; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .warning { background: #5a4d1d; padding: 10px; margin: 10px 0; border-radius: 4px; }
        button { background: #0e639c; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 4px; }
        button:hover { background: #1177bb; }
        pre { background: #2d2d30; padding: 10px; border-radius: 4px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #3e3e42; padding: 8px; text-align: left; }
        th { background: #2d2d30; }
    </style>
</head>
<body>
    <h1>ğŸ” BorÃ§ Transferi Debug Tool</h1>
    
    <div class="info">
        <strong>Bu araÃ§ borÃ§ transferi kayÄ±tlarÄ±nÄ± kontrol eder ve sorunlarÄ± tespit eder.</strong>
    </div>

    <button onclick="checkDatabase()">1. VeritabanÄ±nÄ± Kontrol Et</button>
    <button onclick="checkInMemory()">2. Bellekteki Verileri Kontrol Et</button>
    <button onclick="checkFilters()">3. Filtreleri Test Et</button>
    <button onclick="fixAll()">4. Hepsini DÃ¼zelt</button>

    <div id="output"></div>

    <script type="module">
        import { getDocs, collection } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { db } from './src/services/firebase.js';

        const output = document.getElementById('output');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            output.appendChild(div);
        }

        function clear() {
            output.innerHTML = '';
        }

        window.checkDatabase = async function() {
            clear();
            log('ğŸ” VeritabanÄ± sorgulanÄ±yor...', 'info');
            
            try {
                const snapshot = await getDocs(collection(db, 'islemler'));
                
                const allTransactions = [];
                const debtTransfers = [];
                const deletedDebtTransfers = [];
                const migrationFlaggedDebtTransfers = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const transaction = { id: doc.id, ...data };
                    allTransactions.push(transaction);
                    
                    const type = String(data.islemTipi || '').toLowerCase().trim();
                    const isDebtTransfer = type === 'borÃ§ transferi' || 
                                          type === 'borc transferi' || 
                                          type === 'debt_transfer';
                    
                    if (isDebtTransfer) {
                        debtTransfers.push(transaction);
                        
                        if (data.isDeleted === true) {
                            deletedDebtTransfers.push(transaction);
                        }
                        
                        if (data.migrationFlag === true || data.needsReview === true) {
                            migrationFlaggedDebtTransfers.push(transaction);
                        }
                    }
                });
                
                log(`<strong>âœ… SonuÃ§lar:</strong><br>
                    ğŸ“Š Toplam Ä°ÅŸlem: ${allTransactions.length}<br>
                    ğŸ’œ BorÃ§ Transferi: ${debtTransfers.length}<br>
                    ğŸ—‘ï¸ SilinmiÅŸ BorÃ§ Transferi: ${deletedDebtTransfers.length}<br>
                    ğŸ”– Migration Flag'li: ${migrationFlaggedDebtTransfers.length}`, 
                    debtTransfers.length > 0 ? 'success' : 'warning'
                );
                
                if (debtTransfers.length > 0) {
                    log('<strong>Ä°lk 5 BorÃ§ Transferi:</strong>', 'info');
                    const table = document.createElement('table');
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tip</th>
                                <th>Tutar</th>
                                <th>isDeleted</th>
                                <th>migrationFlag</th>
                                <th>needsReview</th>
                                <th>isLog</th>
                                <th>affectsBalance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${debtTransfers.slice(0, 5).map(tx => `
                                <tr>
                                    <td>${tx.id.substring(0, 8)}...</td>
                                    <td>${tx.islemTipi}</td>
                                    <td>${tx.toplamTutar || tx.tutar || 0}</td>
                                    <td>${tx.isDeleted || false}</td>
                                    <td>${tx.migrationFlag || false}</td>
                                    <td>${tx.needsReview || false}</td>
                                    <td>${tx.isLog || false}</td>
                                    <td>${tx.affectsBalance !== false}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    `;
                    output.appendChild(table);
                    
                    if (migrationFlaggedDebtTransfers.length > 0) {
                        log(`âš ï¸ SORUN: ${migrationFlaggedDebtTransfers.length} borÃ§ transferi migration flag'li!<br>
                            Bu kayÄ±tlar gÃ¶rÃ¼nmÃ¼yor olabilir.`, 'warning');
                    }
                    
                    if (deletedDebtTransfers.length > 0) {
                        log(`âš ï¸ SORUN: ${deletedDebtTransfers.length} borÃ§ transferi silinmiÅŸ olarak iÅŸaretli!`, 'error');
                    }
                } else {
                    log('âŒ VERÄ°TABANINDA HÄ°Ã‡ BORÃ‡ TRANSFERÄ° KAYDI YOK!', 'error');
                }
                
            } catch (error) {
                log(`âŒ Hata: ${error.message}`, 'error');
                console.error(error);
            }
        };

        window.checkInMemory = function() {
            clear();
            log('ğŸ” Bellekteki veriler kontrol ediliyor...', 'info');
            
            // index.html'deki global deÄŸiÅŸkenlere eriÅŸim
            if (typeof window.allIslemler !== 'undefined') {
                const all = window.allIslemler || [];
                const debtTransfers = all.filter(tx => {
                    const type = String(tx.islemTipi || '').toLowerCase().trim();
                    return type === 'borÃ§ transferi' || type === 'borc transferi' || type === 'debt_transfer';
                });
                
                log(`<strong>Bellekteki Veriler:</strong><br>
                    ğŸ“Š Toplam: ${all.length}<br>
                    ğŸ’œ BorÃ§ Transferi: ${debtTransfers.length}`, 
                    debtTransfers.length > 0 ? 'success' : 'error'
                );
                
                if (debtTransfers.length > 0) {
                    log('<pre>' + JSON.stringify(debtTransfers[0], null, 2) + '</pre>', 'info');
                }
            } else {
                log('âŒ window.allIslemler bulunamadÄ±! index.html yÃ¼klÃ¼ deÄŸil.', 'error');
            }
        };

        window.checkFilters = async function() {
            clear();
            log('ğŸ” Filtreler test ediliyor...', 'info');
            
            try {
                // Test transaction
                const testTx = {
                    id: 'test-123',
                    islemTipi: 'borÃ§ transferi',
                    toplamTutar: 1000,
                    migrationFlag: true,
                    needsReview: false,
                    isDeleted: false,
                    isLog: false
                };
                
                // Test filters
                const type = String(testTx.islemTipi || '').toLowerCase().trim();
                const isDebtTransfer = type === 'borÃ§ transferi' || 
                                      type === 'borc transferi' || 
                                      type === 'debt_transfer';
                
                const isMigrationRecord = (testTx.migrationFlag === true || testTx.needsReview === true) && !isDebtTransfer;
                const shouldBeVisible = !testTx.isDeleted && !isMigrationRecord;
                
                log(`<strong>Test SonuÃ§larÄ±:</strong><br>
                    Test Ä°ÅŸlem: BorÃ§ Transferi (migrationFlag: true)<br><br>
                    âœ“ isDebtTransfer: ${isDebtTransfer}<br>
                    âœ“ isMigrationRecord: ${isMigrationRecord}<br>
                    âœ“ shouldBeVisible: ${shouldBeVisible}<br><br>
                    ${shouldBeVisible ? 'âœ… GÃ–RÃœNMELÄ°' : 'âŒ GÃ–RÃœNMEMELÄ°'}`,
                    shouldBeVisible ? 'success' : 'error'
                );
                
            } catch (error) {
                log(`âŒ Hata: ${error.message}`, 'error');
            }
        };

        window.fixAll = async function() {
            clear();
            
            if (!confirm('âš ï¸ TÃœM BORÃ‡ TRANSFERLERÄ° DÃœZELTÄ°LECEK!\n\nDevam etmek istediÄŸinize emin misiniz?')) {
                return;
            }
            
            log('ğŸ”§ DÃ¼zeltme baÅŸlatÄ±lÄ±yor...', 'info');
            
            try {
                if (typeof window.adminUtils !== 'undefined') {
                    log('Admin utilities kullanÄ±lÄ±yor...', 'info');
                    const result = await window.adminUtils.fixDebtTransferVisibility(false);
                    
                    log(`<strong>âœ… TamamlandÄ±!</strong><br>
                        Toplam: ${result.transactions.total}<br>
                        DÃ¼zeltildi: ${result.transactions.fixed}<br>
                        Zaten doÄŸru: ${result.transactions.alreadyCorrect}`, 
                        'success'
                    );
                    
                    log('<strong>Åimdi sayfayÄ± yenileyin!</strong>', 'warning');
                } else {
                    log('âŒ window.adminUtils bulunamadÄ±! Ana uygulamayÄ± aÃ§Ä±n.', 'error');
                }
            } catch (error) {
                log(`âŒ Hata: ${error.message}`, 'error');
                console.error(error);
            }
        };
        
        // Otomatik baÅŸlat
        log('HazÄ±r! YukarÄ±daki butonlarÄ± kullanarak kontrol edin.', 'info');
    </script>
</body>
</html>

