<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BorÃ§ Transferi DÃ¼zeltme</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #28a745;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #dc3545;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 10px 10px 0;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 14px;
        }
        .step {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }
        .step h3 {
            margin-top: 0;
        }
        #status {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ BorÃ§ Transferi GÃ¶rÃ¼nÃ¼rlÃ¼k DÃ¼zeltmesi</h1>
        
        <div class="warning">
            <strong>âš ï¸ Ã–nemli:</strong> Bu sayfa tÃ¼m borÃ§ transferi kayÄ±tlarÄ±nÄ± dÃ¼zeltir ve Ä°ÅŸlem GeÃ§miÅŸi'nde gÃ¶rÃ¼nmelerini saÄŸlar.
        </div>

        <div class="step">
            <h3>AdÄ±m 1: Ã–nizleme</h3>
            <p>Hangi kayÄ±tlarÄ±n etkileneceÄŸini gÃ¶rmek iÃ§in Ã¶nce Ã¶nizleme yapÄ±n:</p>
            <button id="btnPreview">ğŸ” Ã–nizleme Yap</button>
        </div>

        <div class="step">
            <h3>AdÄ±m 2: DÃ¼zeltme</h3>
            <p>Ã–nizleme sonuÃ§larÄ±ndan memnunsanÄ±z, dÃ¼zeltmeyi uygulayÄ±n:</p>
            <button id="btnApply" class="btn-danger" disabled>âœ… DÃ¼zeltmeyi Uygula</button>
        </div>

        <div class="step">
            <h3>AdÄ±m 3: DoÄŸrulama</h3>
            <p>Bakiyelerin doÄŸru olduÄŸunu kontrol edin:</p>
            <button id="btnVerify" class="btn-success" disabled>ğŸ” Bakiyeleri Kontrol Et</button>
        </div>

        <div id="status"></div>

        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
            <small style="color: #666;">
                <strong>Manuel KullanÄ±m:</strong> Bu iÅŸlemleri tarayÄ±cÄ± konsolundan da yapabilirsiniz:
                <pre>await window.adminUtils.fixDebtTransferVisibility() // Ã–nizleme
await window.adminUtils.fixDebtTransferVisibility(false) // Uygulama
await window.adminUtils.verifyBalances() // DoÄŸrulama</pre>
            </small>
        </div>
    </div>

    <script type="module">
        import adminUtils from './src/utils/admin-console.js';

        const btnPreview = document.getElementById('btnPreview');
        const btnApply = document.getElementById('btnApply');
        const btnVerify = document.getElementById('btnVerify');
        const statusDiv = document.getElementById('status');

        let previewSummary = null;

        function showStatus(message, type = 'info') {
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'warning';
            statusDiv.innerHTML = `<div class="${className}">${message}</div>`;
        }

        function showLoading(message) {
            statusDiv.innerHTML = `
                <div class="warning">
                    <strong>â³ Ä°ÅŸlem devam ediyor...</strong><br>
                    ${message}
                </div>
            `;
        }

        function formatSummary(summary, isDryRun) {
            const tx = summary.transactions || {};
            let html = `
                <div class="success">
                    <h3>${isDryRun ? 'ğŸ” Ã–nizleme SonuÃ§larÄ±' : 'âœ… DÃ¼zeltme TamamlandÄ±'}</h3>
                    <p><strong>Toplam BorÃ§ Transferi:</strong> ${tx.total || 0}</p>
                    <p><strong>${isDryRun ? 'DÃ¼zeltilecek' : 'DÃ¼zeltildi'}:</strong> ${tx.fixed || 0}</p>
                    <p><strong>Zaten DoÄŸru:</strong> ${tx.alreadyCorrect || 0}</p>
                    <p><strong>SÃ¼re:</strong> ${summary.duration}</p>
            `;

            if (tx.changes && tx.changes.length > 0) {
                html += `
                    <hr style="margin: 15px 0;">
                    <p><strong>DeÄŸiÅŸiklikler (ilk 5):</strong></p>
                    <ul>
                `;
                tx.changes.slice(0, 5).forEach(change => {
                    html += `<li>${change.id}: ${change.updates.join(', ')}</li>`;
                });
                if (tx.changes.length > 5) {
                    html += `<li><em>... ve ${tx.changes.length - 5} tane daha</em></li>`;
                }
                html += `</ul>`;
            }

            if (summary.balances && summary.balances.length > 0) {
                html += `
                    <hr style="margin: 15px 0;">
                    <p><strong>âš ï¸ Bakiye UyumsuzluklarÄ±:</strong> ${summary.balances.length} hesap</p>
                `;
            }

            html += `</div>`;
            return html;
        }

        btnPreview.addEventListener('click', async () => {
            try {
                btnPreview.disabled = true;
                showLoading('BorÃ§ transferi kayÄ±tlarÄ± analiz ediliyor...');

                previewSummary = await adminUtils.fixDebtTransferVisibility(true);
                
                statusDiv.innerHTML = formatSummary(previewSummary, true);
                
                if (previewSummary.transactions && previewSummary.transactions.fixed > 0) {
                    btnApply.disabled = false;
                }
                btnVerify.disabled = false;
            } catch (error) {
                showStatus(`<strong>Hata:</strong> ${error.message}`, 'error');
            } finally {
                btnPreview.disabled = false;
            }
        });

        btnApply.addEventListener('click', async () => {
            const confirmed = confirm(
                'âš ï¸ DÄ°KKAT!\n\n' +
                'Bu iÅŸlem veritabanÄ±ndaki borÃ§ transferi kayÄ±tlarÄ±nÄ± gÃ¼ncelleyecek.\n\n' +
                'Devam etmek istediÄŸinize emin misiniz?'
            );

            if (!confirmed) return;

            try {
                btnApply.disabled = true;
                btnPreview.disabled = true;
                showLoading('DÃ¼zeltmeler uygulanÄ±yor... (Bu birkaÃ§ dakika sÃ¼rebilir)');

                const summary = await adminUtils.fixDebtTransferVisibility(false);
                
                statusDiv.innerHTML = formatSummary(summary, false);

                if (summary.transactions && summary.transactions.fixed > 0) {
                    statusDiv.innerHTML += `
                        <div class="success" style="margin-top: 20px;">
                            <strong>ğŸ‰ BaÅŸarÄ±lÄ±!</strong><br>
                            ArtÄ±k tÃ¼m borÃ§ transferleri Ä°ÅŸlem GeÃ§miÅŸi'nde gÃ¶rÃ¼necek.<br><br>
                            <button onclick="location.reload()" class="btn-success">ğŸ”„ SayfayÄ± Yenile</button>
                        </div>
                    `;
                }
            } catch (error) {
                showStatus(`<strong>Hata:</strong> ${error.message}`, 'error');
            } finally {
                btnApply.disabled = false;
                btnPreview.disabled = false;
            }
        });

        btnVerify.addEventListener('click', async () => {
            try {
                btnVerify.disabled = true;
                showLoading('Hesap bakiyeleri kontrol ediliyor...');

                const mismatches = await adminUtils.verifyBalances();
                
                if (mismatches.length === 0) {
                    showStatus('<strong>ğŸ‰ MÃ¼kemmel!</strong><br>TÃ¼m bakiyeler doÄŸru. HiÃ§bir uyumsuzluk bulunamadÄ±.', 'success');
                } else {
                    let html = `
                        <div class="warning">
                            <strong>âš ï¸ Bakiye UyumsuzluklarÄ±:</strong> ${mismatches.length} hesap<br><br>
                            <ul>
                    `;
                    mismatches.forEach(m => {
                        html += `
                            <li>
                                <strong>${m.accountName}</strong><br>
                                VeritabanÄ±: â‚º${m.storedBalance.toLocaleString('tr-TR')}<br>
                                Hesaplanan: â‚º${m.calculatedBalance.toLocaleString('tr-TR')}<br>
                                Fark: â‚º${m.difference.toLocaleString('tr-TR')}
                            </li>
                        `;
                    });
                    html += `</ul></div>`;
                    statusDiv.innerHTML = html;
                }
            } catch (error) {
                showStatus(`<strong>Hata:</strong> ${error.message}`, 'error');
            } finally {
                btnVerify.disabled = false;
            }
        });
    </script>
</body>
</html>

